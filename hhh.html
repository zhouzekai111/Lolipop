<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>微博热搜实时追踪</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            background: #e94b3f;
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
        }
        .rankings {
            padding: 20px;
        }
        .hot-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: all 0.3s;
        }
        .hot-item:hover {
            background: #f9f9f9;
        }
        .rank {
            width: 40px;
            font-weight: bold;
            color: #666;
        }
        .keyword {
            flex: 1;
            font-size: 16px;
        }
        .heat {
            width: 100px;
            text-align: right;
            color: #e94b3f;
        }
        .tag {
            margin-left: 10px;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
        }
        .new { background: #ffdce0; color: #cf1322; }
        .hot { background: #fff1f0; color: #f5222d; }
        .boom { background: #fadb14; color: #000; }
        @keyframes highlight {
            from { background: #fffbe6; }
            to { background: transparent; }
        }
        .updated {
            animation: highlight 1.5s;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>微博实时热搜榜</h1>
            <div>更新时间：<span id="updateTime">正在获取...</span></div>
        </div>
        <div class="rankings" id="rankings"></div>
    </div>

    <script>
        // 动态创建热搜条目
        function createHotItem(item) {
            const div = document.createElement('div');
            div.className = 'hot-item';
            
            div.innerHTML = `
                <div class="rank">${item.rank}</div>
                <div class="keyword">
                    ${item.keyword}
                    ${item.tag ? `<span class="tag ${item.tag}">${item.tag.toUpperCase()}</span>` : ''}
                </div>
                <div class="heat">${item.heat}℃</div>
            `;
            
            return div;
        }

        // 更新整个榜单
        function updateRankings(data) {
            const container = document.getElementById('rankings');
            const fragment = document.createDocumentFragment();
            
            data.forEach(item => {
                const existingItem = container.querySelector(`[data-rank="${item.rank}"]`);
                if (existingItem) {
                    // 触发更新动画
                    if (existingItem.dataset.keyword !== item.keyword) {
                        existingItem.classList.add('updated');
                        setTimeout(() => {
                            existingItem.classList.remove('updated');
                        }, 1500);
                    }
                    existingItem.innerHTML = createHotItem(item).innerHTML;
                    existingItem.dataset = item;
                } else {
                    const newItem = createHotItem(item);
                    newItem.dataset.rank = item.rank;
                    fragment.appendChild(newItem);
                }
            });
            
            document.getElementById('updateTime').textContent = 
                new Date().toLocaleTimeString();
            container.prepend(fragment);
        }

        // WebSocket连接
        const socket = new WebSocket('wss://your-backend.com/weibo-hot');

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            updateRankings(data);
        };

        socket.onerror = (error) => {
            console.error('WebSocket Error:', error);
        };

        // 每60秒主动请求更新（备用）
        setInterval(async () => {
            try {
                const response = await fetch('/api/weibo-hot');
                const data = await response.json();
                updateRankings(data);
            } catch (error) {
                console.error('Fetch Error:', error);
            }
        }, 60000);
    </script>
</body>
</html>

from flask import Flask, jsonify
from flask_cors import CORS
import requests
from bs4 import BeautifulSoup
from threading import Thread
import time

app = Flask(__name__)
CORS(app)

latest_data = []
update_lock = False

def fetch_weibo_hot():
    global latest_data, update_lock
    while True:
        try:
            if update_lock:
                continue
                
            update_lock = True
            url = 'https://s.weibo.com/top/summary'
            headers = {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) ...'
            }
            
            response = requests.get(url, headers=headers)
            soup = BeautifulSoup(response.text, 'html.parser')
            
            hot_list = []
            for item in soup.select('.data tbody tr'):
                rank = item.select_one('td.ranktop').get('value')
                keyword = item.select_one('td a').text
                tag = item.select_one('td span')['class'][0] if item.select_one('td span') else ''
                heat = item.select_one('td span').text if item.select_one('td span') else ''
                
                hot_list.append({
                    'rank': int(rank),
                    'keyword': keyword,
                    'tag': tag,
                    'heat': heat
                })
            
            latest_data = hot_list[:50]
            update_lock = False
            time.sleep(60)  # 每分钟更新
            
        except Exception as e:
            print(f"Error fetching data: {str(e)}")
            time.sleep(30)

@app.route('/api/weibo-hot')
def get_hot():
    return jsonify({'data': latest_data})

if __name__ == '__main__':
    Thread(target=fetch_weibo_hot).start()
    app.run(port=5000, debug=False)

    pip install flask beautifulsoup4 requests flask-cors
    python app.py
    server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://localhost:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /socket.io {
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
