# 安装依赖
# pip install flask transformers torch jieba

# app.py
from flask import Flask, render_template, request
from transformers import AutoTokenizer, AutoModelForSeq2SeqLM
import jieba
import re

app = Flask(__name__)

# 加载专业古诗模型
tokenizer = AutoTokenizer.from_pretrained("gpt2-chinese-poem")
model = AutoModelForSeq2SeqLM.from_pretrained("gpt2-chinese-poem")

# 风格映射字典
STYLE_PROMPTS = {
    "平实质朴": "[朴实]",
    "含蓄隽永": "[含蓄]",
    "绚丽飘逸": "[绚丽]",
    "简洁明快": "[明快]",
    "雄浑壮丽": "[雄浑]",
    "粗犷豪放": "[豪放]",
    "沉郁顿挫": "[沉郁]",
    "缠绵哀怨": "[哀怨]"
}

def generate_jueju(keywords, style):
    # 构建符合古诗格式的prompt
    style_tag = STYLE_PROMPTS.get(style, "")
    prompt = f"{style_tag}{'，'.join(keywords)}"
    
    # 生成参数设置
    inputs = tokenizer(prompt, return_tensors="pt", max_length=32, truncation=True)
    outputs = model.generate(
        inputs.input_ids,
        max_length=64,
        num_beams=5,
        early_stopping=True,
        no_repeat_ngram_size=2
    )
    
    # 解码和后处理
    generated = tokenizer.decode(outputs[0], skip_special_tokens=True)
    return format_poem(generated)

def format_poem(text):
    # 使用正则表达式提取符合五言绝句格式的内容
    sentences = re.findall(r'[\u4e00-\u9fa5]{5}[，。]', text)
    valid = []
    for s in sentences[:4]:
        if len(s) == 6 and s[-1] in ["，", "。"]:
            valid.append(s[:5] + s[-1])
    # 确保押韵
    if len(valid) >=4:
        last_char = valid[3][4]
        valid[1] = valid[1][:4] + "，"
        valid[3] = valid[3][:4] + "。"
        if valid[0][4] != "，" or valid[2][4] != "，":
            valid = [s[:4]+"，" if i%2==0 else s[:4]+"。" for i,s in enumerate(valid[:4])]
    return "\n".join(valid[:4])

@app.route('/', methods=['GET', 'POST'])
def index():
    if request.method == 'POST':
        keywords = request.form.get('keywords', '').split()
        style = request.form.get('style', '平实质朴')
        
        if not 2 <= len(keywords) <=5:
            return render_template('index.html', 
                error="请输入2-5个关键词，用空格分隔哦~")
            
        try:
            poem = generate_jueju(keywords, style)
            return render_template('result.html', 
                poem=poem,
                keywords=keywords,
                style=style)
        except Exception as e:
            return render_template('index.html', 
                error="诗歌生成失败，请稍后再试...")
    
    return render_template('index.html')

if __name__ == '__main__':
    app.run(port=5000, debug=True)
<!-- templates/index.html -->
<!DOCTYPE html>
<html>
<head>
    <title>五言绝句生成器</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .poem-container {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .chinese-font {
            font-family: 'STKaiti', '华文楷体', serif;
        }
        .input-style {
            border-radius: 25px;
            padding: 15px 25px;
            border: 2px solid #dee2e6;
            transition: all 0.3s;
        }
        .input-style:focus {
            border
